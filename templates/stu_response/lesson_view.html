{% extends 'base.html' %}

{%block head%}
<script src="/static/js/jquery.js"></script>
<script>
$(document).ready(function(){
    addResponses({{responses|safe}});
    $("#response_form").submit(function(){
        responses = [];
        var data = $(".question");
        for(var x = 0; x<data.length; x++){
            var id = $(data[x]).children('.q_id').val();
            var response = $(data[x]).children('.response').val();
            responses.push({id:id,response:response});
        }        
        $("#responses").val(JSON.stringify(responses));

        if(opener!=null){
            $.post(window.location.href,{"responses":JSON.stringify(responses)},function(data){
                if(data.success){
                    opener.location.reload(true);
                    window.close();
                }
            });
            return false;
        }
        return true;
    });
    $("#save").click(function(){
        responses = [];
        var data = $(".question");
        for(var x = 0; x<data.length; x++){
            var id = $(data[x]).children('.q_id').val();
            var response = $(data[x]).children('.response').val();
            responses.push({id:id,response:response});
        }
        $("#responses").val(JSON.stringify(responses));
        $.post(window.location.href,{"responses":JSON.stringify(responses)},function(data){
            if(data.success){
                if(opener!=null){
                    opener.location.reload(true);
                }
            }
        });
        return false;
    });
    function addResponses(arr){        
        if (arr.length!=0){
            questions = $(".question");
            for(var x = 0; x<questions.length; x++){
                $(questions[x]).children('.response').text(arr[x].response);
                $(questions[x]).next(".comment").text(arr[x].comment);
            } 
        }
    }
});
</script>
<style type="text/css">
    #content-container{
        width:auto;
    }
    #response_form{
        width:450px;
        margin: 0 auto;
    }
    .question{
        width:300px;
    }
    .comment{
        color:gray;
        font-size: .7em;
    }
    #response_form textarea{
        width:100%;
        resize:vertical;
    }
    h1{
        text-align: center;
    }
    #topbar{
        min-width:400px;
    }
    table{
        width:100%;
        border-spacing: 20px 5px;
    }
</style>
{%endblock%}
{%block content%}
<h1>{{lesson.name}}</h1>
<form id="response_form" method="post">
    <table>
        {%for x in questions%}
        <tr>
            <td class="question">
                <span class="qnum">{{x.q_num}}</span>. {{x.text}}<br/>
                <input type="hidden" class="q_id" value="{{x.id}}"/>
                <textarea class="response" rows="6"></textarea><br/>
            </td>
            <td class="comment">
                {{x.comment}}
            </td>
        </tr>
        {%endfor%}
    </table>
    <input type="hidden" name="responses" id="responses"/>
    <br/>
    <input type="button" id="save" value="Save"/>
    <input type="submit" value="Save and close"/>
</form>
{%endblock%}